<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stableford – Scoreboard</title>
  <style>
    :root{
      --bg:#070A12;
      --card:#0E1422;
      --line:#24304A;
      --text:#F3F6FF;
      --muted:#A7B1C8;

      --good:#0F6A4F;
      --warn:#8A6D00;
      --bad:#7A1F1F;

      --shadow: 0 18px 48px rgba(0,0,0,.50);
      --r:18px;

      --rowA: rgba(255,255,255,.03);
      --rowB: rgba(255,255,255,.06);
      --rowHover: rgba(31,166,122,.10);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1400px 800px at 50% -12%, #1b2a66 0%, rgba(27,42,102,0) 55%),
        radial-gradient(1000px 700px at 85% 120%, #0f5b3f55 0%, rgba(15,91,63,0) 55%),
        var(--bg);
    }

    .wrap{ max-width:1400px; margin:0 auto; padding:18px 18px 26px; }

    .top{
      display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap;
      border:1px solid var(--line); border-radius:var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      padding:14px 16px;
    }
    h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .sub{ margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; }

    .meta{
      margin-left:auto;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      color:var(--muted);
      background: rgba(0,0,0,.22);
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      white-space:nowrap;
    }

    .controls{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      margin-top:12px;
    }
    .controls .box{
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(0,0,0,.22);
      padding:10px 12px;
      display:flex; gap:10px; align-items:center;
    }
    .controls label{
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      letter-spacing:.02em;
    }
    .controls input{
      width:90px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    .controls input:focus{
      border-color: rgba(31,166,122,.65);
      box-shadow: 0 0 0 2px rgba(31,166,122,.20);
    }
    button{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      font-size:14px;
    }
    button:hover{ filter: brightness(1.12); }
    button:active{ transform: translateY(1px); }

    .status{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(0,0,0,.22);
      color:var(--muted);
      font-size:12.5px;
      white-space:pre-wrap;
      min-height: 46px;
    }

    .tableWrap{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:var(--r);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: rgba(0,0,0,.18);
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      font-size:14px;
    }

    thead th{
      position: sticky;
      top: 0;
      z-index: 5;
      background: rgba(14,20,34,.92);
      backdrop-filter: blur(6px);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 12px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      text-align:left;
      white-space:nowrap;
    }

    tbody td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      vertical-align: middle;
      white-space:nowrap;
    }

    tbody tr:nth-child(odd){ background: var(--rowA); }
    tbody tr:nth-child(even){ background: var(--rowB); }
    tbody tr:hover{ background: var(--rowHover); }

    .rank{
      width:64px;
      font-weight:1100;
      font-size:15px;
    }
    .points{
      font-weight:1200;
      font-size:16px;
    }
    .muted{ color: var(--muted); }
    .small{ font-size:12px; color: var(--muted); }

    .badge{
      display:inline-block;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-weight:1000;
      font-size:12px;
    }
    .badge.good{ border-color: rgba(31,166,122,.55); color:#40e3a8; }
    .badge.warn{ border-color: rgba(255,204,0,.55); color:#ffcc00; }
    .badge.bad { border-color: rgba(255,92,92,.55); color:#ff7a7a; }

    .nameCell{
      display:flex; gap:10px; align-items:center;
      min-width: 260px;
    }
    .alias{
      font-weight:1100;
      font-size:15px;
      cursor: text;
      padding:4px 8px;
      border-radius:10px;
      border:1px solid transparent;
    }
    .alias:hover{
      border-color: rgba(255,255,255,.14);
      background: rgba(0,0,0,.10);
    }
    .alias[contenteditable="true"]{
      border-color: rgba(31,166,122,.65);
      background: rgba(0,0,0,.22);
      outline:none;
    }

    .right{
      text-align:right;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Stableford Scoreboard</h1>
      <div class="sub">
        Hoogste score staat altijd bovenaan. Dubbelklik op een naam om alias aan te passen (alleen op dit scherm).
      </div>
    </div>
    <div class="meta">
      <span class="pill" id="pillEvent">event: —</span>
      <span class="pill" id="pillRound">round: —</span>
      <span class="pill" id="pillApi">api: —</span>
      <span class="pill" id="pillUpdated">updated: —</span>
    </div>
  </div>

  <div class="controls">
    <div class="box">
      <label for="refreshSec">Refresh (sec)</label>
      <input id="refreshSec" type="number" min="5" max="600" step="1" value="30" />
      <button onclick="applyRefresh()">Apply</button>
    </div>
    <button onclick="refreshNow()">Refresh now</button>
  </div>

  <div class="status" id="status">Status: laden…</div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th class="rank">#</th>
          <th>Speler (alias)</th>
          <th class="right">Punten</th>
          <th class="right">Hole</th>
          <th class="right">Thru</th>
          <th class="right">Totaal holes</th>
          <th class="right">HCP</th>
          <th class="right">Playing HCP</th>
          <th class="right">Gem. tijd / hole</th>
          <th class="right">Tijd op huidige hole</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="11" class="muted" style="padding:14px 12px;">Geen data…</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const api     = qs.get('api') || '';
  const roundId = qs.get('round_id') || qs.get('round') || '';

  function $(id){ return document.getElementById(id); }
  function trunc(s,n){ s=String(s||''); return s.length>n ? s.slice(0,n-1)+'…' : s; }

  function setStatus(msg){ $('status').textContent = 'Status: ' + msg; }

  async function apiGet(params){
    const u = new URL(api);
    Object.entries(params).forEach(([k,v])=> u.searchParams.set(k, String(v)));
    const res = await fetch(u.toString());
    const text = await res.text();
    let json=null; try{ json=JSON.parse(text); }catch{}
    return {res, text, json};
  }

  function aliasKey(pid){
    // alias per round + player_id (zodat dezelfde P001 in andere round niet overlapt)
    return `stable_alias_${roundId}_${pid}`;
  }
  function getAlias(pid){
    return localStorage.getItem(aliasKey(pid)) || '';
  }
  function setAlias(pid, name){
    localStorage.setItem(aliasKey(pid), String(name||'').trim());
  }

  function parseIso(iso){
    const t = Date.parse(iso || '');
    return isNaN(t) ? null : t;
  }

  function fmtDuration(ms){
    if (ms === null || ms === undefined) return '—';
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const r = s % 60;
    if (m <= 0) return `${r}s`;
    return `${m}m ${String(r).padStart(2,'0')}s`;
  }

  function fmtAvg(msPerHole){
    if (!isFinite(msPerHole) || msPerHole <= 0) return '—';
    return fmtDuration(msPerHole);
  }

  function computeRow(round, player, sbRow){
    const now = Date.now();
    const totalPoints = Number(sbRow?.total_points || 0);
    const thru = Number(sbRow?.thru || 0);
    const totalHoles = Number(player?.holes || round?.holes || 18) || 18;

    const holeNow = (thru >= totalHoles) ? 'KLAAR' : String(thru + 1);

    // avg time per hole: (now - checkin_time) / max(thru,1)
    const checkinMs = parseIso(player?.checkin_time);
    const avg = (checkinMs && thru > 0) ? ( (now - checkinMs) / thru ) : null;

    // time on current hole:
    // - use scoreboard last_update_ts if present (from STABLEFORD.updated_at when available)
    // - else use checkin_time if no scores yet
    const lastUpdate = parseIso(sbRow?.last_update_ts);
    const base = lastUpdate || checkinMs;
    const onHole = base ? (now - base) : null;

    const status =
      String(player?.checked_in || '').toUpperCase() === 'TRUE'
        ? (thru >= totalHoles ? 'FINISHED' : 'LIVE')
        : 'NOT CHECKED-IN';

    return {
      player_id: player?.player_id || sbRow?.player_id || '',
      points: totalPoints,
      thru,
      holeNow,
      totalHoles,
      hcp: player?.hcp ?? '—',
      playing_hcp: player?.playing_hcp ?? '—',
      avgMs: avg,
      onHoleMs: onHole,
      status
    };
  }

  function statusBadge(status){
    if (status === 'LIVE') return `<span class="badge good">LIVE</span>`;
    if (status === 'FINISHED') return `<span class="badge warn">FINISHED</span>`;
    return `<span class="badge bad">NO CHECK-IN</span>`;
  }

  function renderTable(rows, playersById){
    // sort: points desc, then thru desc, then player_id asc
    rows.sort((a,b)=>{
      if (b.points !== a.points) return b.points - a.points;
      if (b.thru !== a.thru) return b.thru - a.thru;
      return String(a.player_id).localeCompare(String(b.player_id));
    });

    const tbody = $('tbody');
    if (!rows.length){
      tbody.innerHTML = `<tr><td colspan="11" class="muted" style="padding:14px 12px;">Geen spelers…</td></tr>`;
      return;
    }

    const html = rows.map((r, i)=>{
      const pid = r.player_id;
      const p = playersById[pid] || {};
      const alias = getAlias(pid) || pid;

      const avgTxt = fmtAvg(r.avgMs);
      const onHoleTxt = fmtDuration(r.onHoleMs);

      // show hole: current or KLAAR
      const holeBadge = (r.holeNow === 'KLAAR')
        ? `<span class="badge warn">KLAAR</span>`
        : `<span class="badge good">${r.holeNow}</span>`;

      return `
        <tr>
          <td class="rank">${i+1}</td>

          <td>
            <div class="nameCell">
              <span class="badge">${pid}</span>
              <div
                class="alias"
                data-pid="${pid}"
                title="Dubbelklik om te wijzigen"
              >${escapeHtml(alias)}</div>
            </div>
            <div class="small muted">
              ${escapeHtml(p.loop_id || '—')} • ${escapeHtml(p.tee || '—')} • ${escapeHtml(p.gender || '—')}
            </div>
          </td>

          <td class="right points">${r.points}</td>
          <td class="right">${holeBadge}</td>
          <td class="right">${r.thru}</td>
          <td class="right">${r.totalHoles}</td>
          <td class="right">${escapeHtml(String(r.hcp))}</td>
          <td class="right">${escapeHtml(String(r.playing_hcp))}</td>
          <td class="right">${avgTxt}</td>
          <td class="right">${onHoleTxt}</td>
          <td>${statusBadge(r.status)}</td>
        </tr>
      `;
    }).join('');

    tbody.innerHTML = html;

    // enable alias editing (dblclick -> contenteditable)
    tbody.querySelectorAll('.alias').forEach(el=>{
      el.addEventListener('dblclick', ()=>{
        el.setAttribute('contenteditable','true');
        el.focus();
        // select text
        const range = document.createRange();
        range.selectNodeContents(el);
        const sel = window.getSelection();
        sel.removeAllRanges(); sel.addRange(range);
      });

      el.addEventListener('keydown', (ev)=>{
        if (ev.key === 'Enter'){
          ev.preventDefault();
          el.blur();
        }
        if (ev.key === 'Escape'){
          ev.preventDefault();
          const pid = el.dataset.pid;
          const old = getAlias(pid) || pid;
          el.textContent = old;
          el.blur();
        }
      });

      el.addEventListener('blur', ()=>{
        const pid = el.dataset.pid;
        const val = String(el.textContent || '').trim();
        // empty => fallback to pid
        if (!val || val === pid){
          localStorage.removeItem(aliasKey(pid));
          el.textContent = pid;
        } else {
          setAlias(pid, val);
          el.textContent = val;
        }
        el.removeAttribute('contenteditable');
      });
    });
  }

  function escapeHtml(s){
    return String(s ?? '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;');
  }

  let timer = null;

  async function refreshNow(){
    try{
      if (!api) return setStatus('API ontbreekt in URL (?api=...)');
      if (!roundId) return setStatus('round_id ontbreekt in URL (?round_id=...)');

      setStatus('laden…');

      const r = await apiGet({ action:'roundState', round_id: roundId });
      if (!r.json || !r.json.ok){
        return setStatus('roundState fout: ' + (r.json?.error || r.text));
      }

      const round = r.json.round || {};
      const players = Array.isArray(r.json.players) ? r.json.players : [];
      const scoreboard = Array.isArray(r.json.scoreboard) ? r.json.scoreboard : [];

      // map players
      const playersById = {};
      for (const p of players){
        playersById[String(p.player_id||'').trim()] = p;
      }

      // build rows:
      // use union of:
      // - scoreboard entries (players with at least 1 score)
      // - players list (checked-in or not) so everyone shows
      const sbByPid = {};
      for (const s of scoreboard){
        const pid = String(s.player_id||'').trim();
        sbByPid[pid] = s;
      }

      const rows = [];
      for (const p of players){
        const pid = String(p.player_id||'').trim();
        rows.push(computeRow(round, p, sbByPid[pid] || null));
      }

      // also catch scoreboard players missing from players (shouldn't happen, but safe)
      for (const pid of Object.keys(sbByPid)){
        if (!playersById[pid]){
          rows.push(computeRow(round, { player_id: pid }, sbByPid[pid]));
        }
      }

      // header pills
      $('pillEvent').textContent = 'event: ' + (round.event_code || '—');
      $('pillRound').textContent = 'round: ' + (round.round_id || roundId || '—');
      $('pillApi').textContent = 'api: ' + trunc(api, 48);
      $('pillUpdated').textContent = 'updated: ' + new Date().toLocaleTimeString();

      renderTable(rows, playersById);

      setStatus(
        `OK • spelers: ${players.length} • leaderboard: ${rows.length}\n` +
        `Refresh elke ${$('refreshSec').value}s (instelbaar)`
      );

    }catch(e){
      setStatus('Fout: ' + (e?.message || e));
    }
  }

  function applyRefresh(){
    let sec = Number($('refreshSec').value || 30);
    if (!isFinite(sec) || sec < 5) sec = 5;
    if (sec > 600) sec = 600;
    $('refreshSec').value = String(sec);

    if (timer) clearInterval(timer);
    timer = setInterval(refreshNow, sec * 1000);
    refreshNow();
  }

  (function init(){
    $('pillApi').textContent = 'api: ' + (api ? trunc(api, 48) : '—');
    $('pillRound').textContent = 'round: ' + (roundId || '—');

    if (!api) return setStatus('API ontbreekt in URL (?api=...)');
    if (!roundId) return setStatus('round_id ontbreekt in URL (?round_id=...)');

    // default 30 sec, but if API config has refresh_seconds we use it (still adjustable)
    (async ()=>{
      const cfg = await apiGet({ action:'config' });
      if (cfg.json && cfg.json.ok && cfg.json.config){
        const rs = Number(cfg.json.config.refresh_seconds || 30);
        if (isFinite(rs) && rs >= 5 && rs <= 600) $('refreshSec').value = String(rs);
      }
      applyRefresh();
    })();
  })();
</script>
</body>
</html>
