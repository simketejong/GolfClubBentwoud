<!doctype html>
<html lang="nl">
<head> 
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stableford – Scoreboard</title>
  <style>
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#070A12; color:#F3F6FF; }
    .wrap{ max-width:1500px; margin:0 auto; padding:18px; }
    .card{ border:1px solid #24304A; border-radius:16px; background:#0E1422; padding:14px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end; margin-top:12px; }
    label{ display:block; font-size:12px; color:#A7B1C8; font-weight:900; letter-spacing:.02em; margin-bottom:6px; }
    input{ padding:10px 12px; border-radius:12px; border:1px solid #24304A; background:#060A14; color:#F3F6FF; font-size:14px; outline:none; }
    button{ padding:10px 12px; border-radius:12px; border:1px solid rgba(255,255,255,.14); background:rgba(255,255,255,.06); color:#F3F6FF; font-weight:900; cursor:pointer; }
    button:hover{ filter:brightness(1.15); }
    .pill{ font-family:ui-monospace,Menlo,Consolas,monospace; font-size:12px; color:#A7B1C8; border:1px solid rgba(255,255,255,.12); border-radius:999px; padding:6px 10px; background:rgba(0,0,0,.25); }
    .status{ margin-top:12px; white-space:pre-wrap; color:#A7B1C8; border:1px solid rgba(255,255,255,.10); border-radius:12px; padding:10px 12px; background:rgba(0,0,0,.25); min-height:56px; }
    table{ width:100%; border-collapse:collapse; margin-top:12px; }
    th,td{ padding:10px 10px; border-bottom:1px solid rgba(255,255,255,.08); }
    th{ text-align:left; color:#A7B1C8; font-size:12px; text-transform:uppercase; letter-spacing:.08em; }
    tr:nth-child(even){ background:rgba(255,255,255,.04); }
    .right{ text-align:right; }
    .name{ font-weight:1100; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h2 style="margin:0;">Stableford Scoreboard</h2>
    <div class="row">
      <div>
        <label>Event code</label>
        <input id="eventInput" placeholder="SF2026" />
      </div>
      <div>
        <label>Refresh (sec)</label>
        <input id="refreshSec" type="number" min="5" max="600" value="30" />
      </div>
      <button onclick="applyEvent()">Gebruik event</button>
      <button onclick="refreshNow()">Refresh nu</button>
      <span class="pill" id="pillApi">api: —</span>
      <span class="pill" id="pillEvent">event: —</span>
      <span class="pill" id="pillTime">—</span>
    </div>

    <div class="status" id="status">Status: laden…</div>

    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Speler</th>
          <th class="right">Punten</th>
          <th class="right">Hole</th>
          <th class="right">Holes</th>
          <th class="right">HCP</th>
          <th class="right">Playing</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="7" style="color:#A7B1C8;">Geen data…</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const api = qs.get('api') || '';
  let eventCode = qs.get('event_code') || '';

  const $ = (id)=>document.getElementById(id);
  const setStatus = (s)=>{ $('status').textContent = 'Status: ' + s; };
  const esc = (s)=>String(s??'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');

  $('pillApi').textContent = 'api: ' + (api ? 'OK' : 'ONTBREEKT');
  $('pillEvent').textContent = 'event: ' + (eventCode || '—');
  $('eventInput').value = eventCode;

  let timer = null;

  async function apiGet(params){
    const u = new URL(api);
    Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,String(v)));
    const res = await fetch(u.toString());
    const text = await res.text();
    let json=null; try{ json = JSON.parse(text); }catch{}
    return { res, text, json, url: u.toString() };
  }

  function render(rows){
    const tb = $('tbody');
    if (!rows.length){
      tb.innerHTML = `<tr><td colspan="7" style="color:#A7B1C8;">Geen spelers…</td></tr>`;
      return;
    }
    tb.innerHTML = rows.map((r,i)=>`
      <tr>
        <td>${i+1}</td>
        <td><span class="name">${esc(r.name)}</span> <span style="color:#A7B1C8;font-family:ui-monospace,Menlo,Consolas,monospace;">(${esc(r.player_id)})</span></td>
        <td class="right">${r.points}</td>
        <td class="right">${r.holeNow}</td>
        <td class="right">${r.totalHoles}</td>
        <td class="right">${esc(r.hcp)}</td>
        <td class="right">${esc(r.playing_hcp)}</td>
      </tr>
    `).join('');
  }

  async function refreshNow(){
    try{
      if (!api){
        setStatus('❌ API ontbreekt in URL. Open scoreboard via admin-mail link (die bevat api=...).');
        return;
      }
      if (!eventCode){
        setStatus('Vul event code in.');
        return;
      }

      setStatus('Laden…');
      const r = await apiGet({ action:'roundState', event_code: eventCode });

      $('pillTime').textContent = new Date().toLocaleTimeString();

      if (!r.json || !r.json.ok){
        setStatus('❌ roundState fout.\n\nGET:\n' + r.url + '\n\nResponse:\n' + (r.text || '—'));
        return;
      }

      const round = r.json.round || {};
      const players = Array.isArray(r.json.players) ? r.json.players : [];
      const scoreboard = Array.isArray(r.json.scoreboard) ? r.json.scoreboard : [];
      const liveNames = r.json.live_names || {};

      // map pid -> player info
      const pById = {};
      for (const p of players) pById[String(p.player_id||'').trim()] = p;

      // merge scoreboard totals per player (sorted by points desc)
      const rows = [];
      for (const s of scoreboard){
        const pid = String(s.player_id||'').trim();
        const p = pById[pid] || { player_id: pid };
        const totalHoles = Number(p.holes || round.holes || 18) || 18;
        const thru = Number(s.thru || 0);
        const holeNow = (thru >= totalHoles) ? 'KLAAR' : String(thru + 1);

        const liveName = liveNames[pid] ? String(liveNames[pid]).trim() : '';
        rows.push({
          player_id: pid,
          name: liveName || pid,
          points: Number(s.total_points || 0),
          holeNow,
          totalHoles,
          hcp: (p.hcp ?? '—'),
          playing_hcp: (p.playing_hcp ?? '—')
        });
      }

      rows.sort((a,b)=> (b.points - a.points) || a.player_id.localeCompare(b.player_id));
      render(rows);

      setStatus(`✅ OK • event=${eventCode} • spelers=${players.length} • refresh=${$('refreshSec').value}s`);
    }catch(e){
      setStatus('❌ Fout: ' + (e?.message || e));
    }
  }

  function applyRefresh(){
    let sec = Number($('refreshSec').value || 30);
    if (!isFinite(sec) || sec < 5) sec = 5;
    if (sec > 600) sec = 600;
    $('refreshSec').value = String(sec);

    if (timer) clearInterval(timer);
    timer = setInterval(refreshNow, sec*1000);
    refreshNow();
  }

  function applyEvent(){
    const v = $('eventInput').value.trim();
    if (!v){ setStatus('Event code is leeg.'); return; }
    eventCode = v;
    $('pillEvent').textContent = 'event: ' + eventCode;
    applyRefresh();
  }

  // init
  if (api) applyRefresh();
  else refreshNow();
</script>
</body>
</html>
