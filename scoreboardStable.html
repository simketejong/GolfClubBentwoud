<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stableford – Scoreboard</title>
  <style>
    :root{
      --bg:#070A12; --card:#0E1422; --line:#24304A; --text:#F3F6FF; --muted:#A7B1C8;
      --shadow: 0 18px 48px rgba(0,0,0,.50);
      --r:18px;
      --rowA: rgba(255,255,255,.03);
      --rowB: rgba(255,255,255,.06);
      --rowHover: rgba(31,166,122,.10);
      --good:#0F6A4F; --warn:#8A6D00; --bad:#7A1F1F;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1400px 800px at 50% -12%, #1b2a66 0%, rgba(27,42,102,0) 55%),
        radial-gradient(1000px 700px at 85% 120%, #0f5b3f55 0%, rgba(15,91,63,0) 55%),
        var(--bg);
    }
    .wrap{ max-width:1500px; margin:0 auto; padding:18px 18px 26px; }
    .top{
      display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap;
      border:1px solid var(--line); border-radius:var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      padding:14px 16px;
    }
    h1{ margin:0; font-size:22px; letter-spacing:.2px; }
    .sub{ margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; }
    .meta{ margin-left:auto; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
      color:var(--muted);
      background: rgba(0,0,0,.22);
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
      white-space:nowrap;
    }
    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-top:12px; }
    .controls .box{
      border:1px solid var(--line);
      border-radius:14px;
      background: rgba(0,0,0,.22);
      padding:10px 12px;
      display:flex; gap:10px; align-items:center;
    }
    .controls label{ color:var(--muted); font-size:12px; font-weight:900; letter-spacing:.02em; }
    .controls input[type="number"]{
      width:90px; padding:8px 10px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color:var(--text);
      font-size:14px; outline:none;
    }
    .controls input[type="text"]{
      width:520px; padding:8px 10px; border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      color:var(--text);
      font-size:13px; outline:none;
      font-family: ui-monospace, SFMono-Regular, Menlo, monospace;
    }
    button{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      font-size:14px;
    }
    button:hover{ filter: brightness(1.12); }
    button:active{ transform: translateY(1px); }

    .status{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(0,0,0,.22);
      color:var(--muted);
      font-size:12.5px;
      white-space:pre-wrap;
      min-height: 46px;
    }

    .tableWrap{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:var(--r);
      overflow:hidden;
      box-shadow: var(--shadow);
      background: rgba(0,0,0,.18);
    }
    table{ width:100%; border-collapse:separate; border-spacing:0; font-size:14px; }
    thead th{
      position: sticky; top: 0; z-index: 5;
      background: rgba(14,20,34,.92);
      backdrop-filter: blur(6px);
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .08em;
      font-size: 12px;
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      text-align:left;
      white-space:nowrap;
    }
    tbody td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      vertical-align: middle;
      white-space:nowrap;
    }
    tbody tr:nth-child(odd){ background: var(--rowA); }
    tbody tr:nth-child(even){ background: var(--rowB); }
    tbody tr:hover{ background: var(--rowHover); }

    .rank{ width:64px; font-weight:1100; font-size:15px; }
    .points{ font-weight:1200; font-size:16px; }
    .right{ text-align:right; }
    .small{ font-size:12px; color: var(--muted); }

    .badge{
      display:inline-block;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      font-weight:1000;
      font-size:12px;
    }
    .badge.good{ border-color: rgba(31,166,122,.55); color:#40e3a8; }
    .badge.warn{ border-color: rgba(255,204,0,.55); color:#ffcc00; }
    .badge.bad { border-color: rgba(255,92,92,.55); color:#ff7a7a; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="top">
    <div>
      <h1>Stableford Scoreboard</h1>
      <div class="sub">Roepnaam is LIVE (niet opgeslagen). Verschijnt zodra iemand checkt-in of een score verzendt.</div>
    </div>
    <div class="meta">
      <span class="pill" id="pillEvent">event: —</span>
      <span class="pill" id="pillRound">round: —</span>
      <span class="pill" id="pillUpdated">updated: —</span>
    </div>
  </div>

  <div class="controls">
    <div class="box">
      <label for="apiInput">API</label>
      <input id="apiInput" type="text" placeholder="https://script.google.com/macros/s/.../exec" />
      <button onclick="applyApi()">Use API</button>
    </div>

    <div class="box">
      <label for="eventInput">Event</label>
      <input id="eventInput" type="text" placeholder="SF2026" />
      <button onclick="applyEvent()">Use Event</button>
    </div>

    <div class="box">
      <label for="refreshSec">Refresh (sec)</label>
      <input id="refreshSec" type="number" min="5" max="600" step="1" value="30" />
      <button onclick="applyRefresh()">Apply</button>
    </div>

    <button onclick="refreshNow()">Refresh now</button>
  </div>

  <div class="status" id="status">Status: vul API + event in.</div>

  <div class="tableWrap">
    <table>
      <thead>
        <tr>
          <th class="rank">#</th>
          <th>Speler</th>
          <th class="right">Punten</th>
          <th class="right">Hole</th>
          <th class="right">Totaal holes</th>
          <th class="right">HCP</th>
          <th class="right">Playing HCP</th>
          <th class="right">Gem. tijd / hole</th>
          <th class="right">Tijd op huidige hole</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="10" class="small" style="padding:14px 12px;">Geen data…</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  let api = qs.get('api') || localStorage.getItem('stable_sb_api') || '';
  let eventCode = qs.get('event_code') || localStorage.getItem('stable_sb_event') || '';

  function $(id){ return document.getElementById(id); }
  function setStatus(msg){ $('status').textContent = 'Status: ' + msg; }
  function escapeHtml(s){
    return String(s ?? '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }
  function parseIso(iso){ const t = Date.parse(iso || ''); return isNaN(t) ? null : t; }
  function fmtDuration(ms){
    if (ms === null || ms === undefined) return '—';
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const r = s % 60;
    if (m <= 0) return `${r}s`;
    return `${m}m ${String(r).padStart(2,'0')}s`;
  }
  function fmtAvg(msPerHole){
    if (!isFinite(msPerHole) || msPerHole <= 0) return '—';
    return fmtDuration(msPerHole);
  }
  function badge(status){
    if (status === 'LIVE') return `<span class="badge good">LIVE</span>`;
    if (status === 'FINISHED') return `<span class="badge warn">FINISHED</span>`;
    return `<span class="badge bad">NO CHECK-IN</span>`;
  }

  async function apiGet(params){
    const u = new URL(api);
    Object.entries(params).forEach(([k,v])=> u.searchParams.set(k, String(v)));
    const res = await fetch(u.toString());
    const text = await res.text();
    let json=null; try{ json=JSON.parse(text); }catch{}
    return {res, text, json};
  }

  function computeRow(round, player, sbRow, liveNames){
    const now = Date.now();
    const points = Number(sbRow?.total_points || 0);
    const thru = Number(sbRow?.thru || 0);
    const totalHoles = Number(player?.holes || round?.holes || 18) || 18;
    const holeNow = (thru >= totalHoles) ? 'KLAAR' : String(thru + 1);

    const checkinMs = parseIso(player?.checkin_time);
    const avg = (checkinMs && thru > 0) ? ((now - checkinMs) / thru) : null;

    const lastUpdate = parseIso(sbRow?.last_update_ts);
    const base = lastUpdate || checkinMs;
    const onHole = base ? (now - base) : null;

    const checked = String(player?.checked_in || '').toUpperCase() === 'TRUE';
    const status = checked ? (thru >= totalHoles ? 'FINISHED' : 'LIVE') : 'NOT CHECKED-IN';

    const pid = String(player?.player_id || sbRow?.player_id || '').trim();
    const liveName = (liveNames && pid && liveNames[pid]) ? String(liveNames[pid] || '').trim() : '';
    const name = liveName ? liveName : pid;

    return {
      player_id: pid,
      name,
      points,
      holeNow,
      totalHoles,
      hcp: player?.hcp ?? '—',
      playing_hcp: player?.playing_hcp ?? '—',
      avgMs: avg,
      onHoleMs: onHole,
      status,
      loop_id: player?.loop_id || '—',
      tee: player?.tee || '—',
      gender: player?.gender || '—'
    };
  }

  function render(rows, round){
    rows.sort((a,b)=>{
      if (b.points !== a.points) return b.points - a.points;
      return String(a.player_id).localeCompare(String(b.player_id));
    });

    const tb = $('tbody');
    if (!rows.length){
      tb.innerHTML = `<tr><td colspan="10" class="small" style="padding:14px 12px;">Geen spelers…</td></tr>`;
      return;
    }

    tb.innerHTML = rows.map((r, i)=>{
      const holeBadge = (r.holeNow === 'KLAAR')
        ? `<span class="badge warn">KLAAR</span>`
        : `<span class="badge good">${r.holeNow}</span>`;

      return `
        <tr>
          <td class="rank">${i+1}</td>
          <td>
            <div style="display:flex; gap:10px; align-items:center;">
              <span class="badge">${escapeHtml(r.player_id)}</span>
              <span style="font-weight:1100; font-size:15px;">${escapeHtml(r.name)}</span>
            </div>
            <div class="small">${escapeHtml(r.loop_id)} • ${escapeHtml(r.tee)} • ${escapeHtml(r.gender)}</div>
          </td>
          <td class="right points">${r.points}</td>
          <td class="right">${holeBadge}</td>
          <td class="right">${r.totalHoles}</td>
          <td class="right">${escapeHtml(String(r.hcp))}</td>
          <td class="right">${escapeHtml(String(r.playing_hcp))}</td>
          <td class="right">${fmtAvg(r.avgMs)}</td>
          <td class="right">${fmtDuration(r.onHoleMs)}</td>
          <td>${badge(r.status)}</td>
        </tr>
      `;
    }).join('');

    $('pillEvent').textContent = 'event: ' + (round?.event_code || eventCode || '—');
    $('pillRound').textContent = 'round: ' + (round?.round_id || '—');
    $('pillUpdated').textContent = 'updated: ' + new Date().toLocaleTimeString();
  }

  let timer = null;

  async function refreshNow(){
    try{
      if (!api) return setStatus('API ontbreekt.');
      if (!eventCode) return setStatus('Event ontbreekt.');

      setStatus('laden…');
      const r = await apiGet({ action:'roundState', event_code: eventCode });

      if (!r.json || !r.json.ok){
        return setStatus('roundState fout: ' + (r.json?.error || r.text));
      }

      const round = r.json.round || {};
      const players = Array.isArray(r.json.players) ? r.json.players : [];
      const scoreboard = Array.isArray(r.json.scoreboard) ? r.json.scoreboard : [];
      const liveNames = r.json.live_names || {};

      const playersById = {};
      for (const p of players) playersById[String(p.player_id||'').trim()] = p;

      const sbByPid = {};
      for (const s of scoreboard) sbByPid[String(s.player_id||'').trim()] = s;

      const rows = [];
      for (const p of players){
        const pid = String(p.player_id||'').trim();
        rows.push(computeRow(round, p, sbByPid[pid] || null, liveNames));
      }
      for (const pid of Object.keys(sbByPid)){
        if (!playersById[pid]) rows.push(computeRow(round, { player_id: pid }, sbByPid[pid], liveNames));
      }

      render(rows, round);
      setStatus(`OK • spelers: ${players.length} • refresh elke ${$('refreshSec').value}s`);
    }catch(e){
      setStatus('Fout: ' + (e?.message || e));
    }
  }

  function applyRefresh(){
    let sec = Number($('refreshSec').value || 30);
    if (!isFinite(sec) || sec < 5) sec = 5;
    if (sec > 600) sec = 600;
    $('refreshSec').value = String(sec);

    if (timer) clearInterval(timer);
    timer = setInterval(refreshNow, sec*1000);
    refreshNow();
  }

  function applyApi(){
    const v = $('apiInput').value.trim();
    if (!v){ api=''; localStorage.removeItem('stable_sb_api'); return setStatus('API leeg.'); }
    api = v;
    localStorage.setItem('stable_sb_api', api);
    setStatus('API ingesteld.');
    applyRefresh();
  }

  function applyEvent(){
    const v = $('eventInput').value.trim();
    if (!v){ eventCode=''; localStorage.removeItem('stable_sb_event'); return setStatus('Event leeg.'); }
    eventCode = v;
    localStorage.setItem('stable_sb_event', eventCode);
    setStatus('Event ingesteld.');
    applyRefresh();
  }

  (function init(){
    $('apiInput').value = api || '';
    $('eventInput').value = eventCode || '';
    $('refreshSec').value = '30';

    if (api && eventCode){
      applyRefresh();
    } else {
      setStatus('Vul API + event in.');
    }
  })();
</script>
</body>
</html>
