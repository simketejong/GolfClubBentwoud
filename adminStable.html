<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – Stableford (Setup)</title>
  <style>
    :root{
      --bg:#070A12;
      --card:#0E1422;
      --line:#24304A;
      --text:#F3F6FF;
      --muted:#A7B1C8;

      --good:#0F6A4F;
      --goodBorder:#1FA67A;

      --warn:#8A6D00;
      --warnBorder:#FFCC00;

      --bad:#7A1F1F;
      --badBorder:#FF5C5C;

      --shadow: 0 18px 48px rgba(0,0,0,.52);
      --r:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 50% -10%, #1b2a66 0%, rgba(27,42,102,0) 55%),
        radial-gradient(900px 600px at 80% 120%, #0f5b3f55 0%, rgba(15,91,63,0) 55%),
        var(--bg);
    }
    .wrap{ max-width:980px; margin:0 auto; padding:16px 14px 28px; }
    .card{
      border:1px solid var(--line);
      border-radius:var(--r);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      padding:14px;
    }
    h1{ margin:0; font-size:20px; letter-spacing:.2px; }
    .sub{ margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:820px){
      .grid{ grid-template-columns: 1fr; }
    }
    label{
      display:block;
      margin:10px 0 6px;
      color:var(--muted);
      font-size:12px;
      font-weight:900;
      letter-spacing:.02em;
    }
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.28);
      color:var(--text);
      font-size:14px;
      outline:none;
    }
    textarea{ min-height: 240px; font-family: var(--mono); font-size:12.5px; line-height:1.45; }
    input:focus, textarea:focus{
      border-color: var(--goodBorder);
      box-shadow: 0 0 0 2px rgba(31,166,122,.22);
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
      align-items:center;
    }
    button{
      padding:12px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:var(--text);
      font-weight:1000;
      cursor:pointer;
      font-size:14px;
    }
    button:hover{ filter:brightness(1.12); }
    button:active{ transform: translateY(1px); }

    .btnGood{ background: var(--good); border-color: var(--goodBorder); }
    .btnWarn{ background: var(--warn); border-color: var(--warnBorder); color:#1a1400; }
    .btnBad{  background: var(--bad);  border-color: var(--badBorder); }
    .btnGood, .btnBad{ color:#fff; }

    .status{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px 12px;
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
      white-space:pre-wrap;
      min-height:48px;
    }
    .pill{
      display:inline-block;
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      padding:6px 10px;
      background: rgba(0,0,0,.20);
      color:var(--muted);
      font-size:12px;
      font-family: var(--mono);
    }
    .kpi{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:10px 12px;
      min-width: 160px;
    }
    .k{ color:var(--muted); font-size:12px; font-weight:900; }
    .v{ margin-top:4px; font-size:18px; font-weight:1100; }
    .help{
      color:var(--muted);
      font-size:12.5px;
      line-height:1.35;
      margin-top:8px;
    }
    .help code{
      font-family: var(--mono);
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      padding:2px 6px;
      border-radius:10px;
      color: var(--text);
    }
    a{ color:#7fe6c0; text-decoration:none; font-weight:900; }
    a:hover{ text-decoration:underline; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>Admin – Stableford setup</h1>
      <div class="sub">
        Plak spelersregels en maak één ronde aan. E-mails worden verzonden, en jij krijgt een Nederlandse samenvatting + scoreboard-link.
      </div>

      <div class="grid">
        <div>
          <label for="apiUrl">Apps Script API URL (exec)</label>
          <input id="apiUrl" placeholder="https://script.google.com/macros/s/.../exec" />

          <label for="eventCode">Event code</label>
          <input id="eventCode" placeholder="bijv. Stablefort-Feb-2026" />

          <label for="adminKey">Admin key</label>
          <input id="adminKey" placeholder="(uit CONFIG.admin_key)" />

          <label for="adminEmail">Admin e-mail (samenvatting)</label>
          <input id="adminEmail" type="email" placeholder="bijv. simketejong@gmail.com" />

          <div class="row">
            <button class="btnGood" onclick="createRound()">Ronde aanmaken + mails sturen</button>
            <button onclick="fillExample()">Voorbeeld vullen</button>
            <span class="pill" id="pillScoreboard">scoreboard: —</span>
          </div>

          <div class="status" id="status">Status: klaar.</div>

          <div class="help">
            <b>Format per regel:</b><br/>
            <code>email,hcp,tee,gender,loop</code> (optioneel: <code>,holes</code>)<br/><br/>
            Voorbeelden:<br/>
            <code>jan@x.nl,18.4,WIT,H,WO</code> (WO/OZ/ZW/ZO ⇒ 18 holes)<br/>
            <code>piet@x.nl,9.2,GEEL,D,O</code> (O/W/Z/N ⇒ default 9 holes)<br/>
            <code>klaas@x.nl,+1.2,ROOD,D,NOORD,18</code> (holes expliciet)
          </div>
        </div>

        <div>
          <label for="players">Spelers (1 per regel)</label>
          <textarea id="players" placeholder="email,hcp,tee,gender,loop[,holes]"></textarea>

          <div class="row">
            <div class="kpi">
              <div class="k">Regels</div>
              <div class="v" id="kpiLines">0</div>
            </div>
            <div class="kpi">
              <div class="k">Geldig</div>
              <div class="v" id="kpiValid">0</div>
            </div>
            <div class="kpi">
              <div class="k">Fouten</div>
              <div class="v" id="kpiErrors">0</div>
            </div>
          </div>

          <div class="status" id="preview">Preview: —</div>
        </div>
      </div>
    </div>
  </div>

<script>
  function $(id){ return document.getElementById(id); }
  function setStatus(msg){ $('status').textContent = 'Status: ' + msg; }

  function norm(s){ return String(s||'').trim(); }
  function normUpper(s){ return norm(s).toUpperCase(); }
  function isEmail(s){
    const e = norm(s).toLowerCase();
    return e.includes('@') && e.includes('.') && e.length >= 6;
  }
  function parseHcp(s){
    const t = norm(s).replace(',', '.');
    if (!t) return null;
    const v = Number(t);
    return Number.isFinite(v) ? v : null;
  }
  function inferHoles(loopRaw){
    const loop = normUpper(loopRaw);
    const combo = new Set(['WO','OZ','ZW','ZO','WEST-OOST','OOST-ZUID','ZUID-WEST']);
    if (combo.has(loop)) return 18;
    // singles default 9
    return 9;
  }
  function normalizeLoop(loopRaw){
    const s = normUpper(loopRaw).replace(/\s+/g,'');
    const map = {
      'WO':'WEST-OOST',
      'OZ':'OOST-ZUID',
      'ZW':'ZUID-WEST',
      'ZO':'ZUID-WEST',
      'O':'OOST',
      'W':'WEST',
      'Z':'ZUID',
      'N':'NOORD',
      'NOORD':'NOORD',
      'OOST':'OOST',
      'WEST':'WEST',
      'ZUID':'ZUID',
      'WEST-OOST':'WEST-OOST',
      'OOST-ZUID':'OOST-ZUID',
      'ZUID-WEST':'ZUID-WEST'
    };
    return map[s] || normUpper(loopRaw);
  }

  function parsePlayersText(text){
    const lines = String(text||'')
      .split(/\r?\n/)
      .map(l => l.trim())
      .filter(l => l && !l.startsWith('#'));

    const out = [];
    const errors = [];

    for (let i=0; i<lines.length; i++){
      const line = lines[i];
      const parts = line.split(',').map(p => p.trim());

      if (parts.length < 5){
        errors.push(`Regel ${i+1}: te weinig velden (min 5) → ${line}`);
        continue;
      }

      const email = parts[0];
      const hcp = parseHcp(parts[1]);
      const tee = normUpper(parts[2]);
      const gender = normUpper(parts[3]); // H/D
      const loopRaw = parts[4];
      const loop_id = normalizeLoop(loopRaw);

      let holes = null;
      if (parts.length >= 6 && parts[5] !== ''){
        const hv = Number(String(parts[5]).trim());
        if (![9,18].includes(hv)){
          errors.push(`Regel ${i+1}: holes moet 9 of 18 zijn → ${line}`);
          continue;
        }
        holes = hv;
      } else {
        holes = inferHoles(loopRaw);
      }

      if (!isEmail(email)){
        errors.push(`Regel ${i+1}: ongeldig e-mail → ${line}`);
        continue;
      }
      if (hcp === null){
        errors.push(`Regel ${i+1}: ongeldig hcp → ${line}`);
        continue;
      }
      if (!tee){
        errors.push(`Regel ${i+1}: tee ontbreekt → ${line}`);
        continue;
      }
      if (!(gender === 'H' || gender === 'D')){
        errors.push(`Regel ${i+1}: gender moet H of D zijn → ${line}`);
        continue;
      }
      if (!loop_id){
        errors.push(`Regel ${i+1}: loop ontbreekt → ${line}`);
        continue;
      }

      out.push({
        email: email.trim().toLowerCase(),
        hcp: hcp,
        tee: tee,
        gender: gender,
        loop_id: loop_id,
        holes: holes
      });
    }

    return { lines, players: out, errors };
  }

  function updatePreview(){
    const parsed = parsePlayersText($('players').value);
    $('kpiLines').textContent = String(parsed.lines.length);
    $('kpiValid').textContent = String(parsed.players.length);
    $('kpiErrors').textContent = String(parsed.errors.length);

    const sample = parsed.players.slice(0, 6).map(p =>
      `${p.email} | hcp ${p.hcp} | ${p.tee} ${p.gender} | ${p.loop_id} | ${p.holes} holes`
    );

    const errSample = parsed.errors.slice(0, 6);

    $('preview').textContent =
      `Preview (max 6):\n${sample.length ? sample.join('\n') : '—'}`
      + (errSample.length ? `\n\nFouten (max 6):\n${errSample.join('\n')}` : '');
  }

  function scoreboardLink(apiUrl, eventCode){
    const base = location.href.split('/').slice(0,-1).join('/') + '/';
    // GitHub pages: we want relative scoreboardStable.html on same repo
    // Use base only if running from GitHub; if opened locally, still fine.
    const sb = base.endsWith('/') ? (base + 'scoreboardStable.html') : (base + '/scoreboardStable.html');
    const u = new URL(sb, location.href);
    u.searchParams.set('api', apiUrl);
    u.searchParams.set('event_code', eventCode);
    return u.toString();
  }

  async function apiPost(apiUrl, payloadObj){
    const data = new URLSearchParams();
    data.set('payload', JSON.stringify(payloadObj));
    const res = await fetch(apiUrl, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body: data.toString()
    });
    const text = await res.text();
    let json=null; try{ json=JSON.parse(text); }catch{}
    return {res, text, json};
  }

  async function createRound(){
    try{
      const apiUrl = norm($('apiUrl').value);
      const eventCode = norm($('eventCode').value);
      const adminKey = norm($('adminKey').value);
      const adminEmail = norm($('adminEmail').value);

      if (!apiUrl) return alert('Vul API URL in.');
      if (!eventCode) return alert('Vul event code in.');
      if (!adminKey) return alert('Vul admin key in.');
      if (!adminEmail || !isEmail(adminEmail)) return alert('Vul een geldig admin e-mailadres in.');

      const parsed = parsePlayersText($('players').value);
      updatePreview();

      if (parsed.errors.length){
        const msg = 'Er zitten fouten in de invoer. Fix eerst dit:\n\n' + parsed.errors.slice(0, 12).join('\n');
        alert(msg);
        return;
      }
      if (!parsed.players.length) return alert('Geen geldige spelers gevonden.');

      const sbLink = scoreboardLink(apiUrl, eventCode);
      $('pillScoreboard').textContent = 'scoreboard: klaar';
      $('pillScoreboard').onclick = () => window.open(sbLink, '_blank');

      setStatus('Bezig… ronde maken + mails versturen…');

      const payload = {
        action: 'adminCreateRoundMixed',
        admin_key: adminKey,
        event_code: eventCode,
        api_url: apiUrl,
        admin_email: adminEmail,
        players: parsed.players
      };

      const r = await apiPost(apiUrl, payload);

      if (r.json && r.json.ok){
        const outSb = r.json.scoreboard_url || sbLink;
        setStatus(
          `✅ Gelukt!\n` +
          `Event: ${r.json.event_code}\n` +
          `Round: ${r.json.round_id}\n` +
          `Players: ${r.json.players_created}\n` +
          `Mails: ${r.json.mails_sent} (errors: ${r.json.errors})\n\n` +
          `Scoreboard:\n${outSb}`
        );

        // show clickable scoreboard link in preview block too
        $('preview').textContent =
          `✅ Ronde aangemaakt.\n\nOpen scoreboard:\n${outSb}\n\n` +
          `Tip: event code kan op scoreboard aangepast worden.\n` +
          `Admin samenvatting gaat naar: ${adminEmail}`;

        // Nice: open scoreboard button
        if (confirm('Ronde aangemaakt. Scoreboard openen?')){
          window.open(outSb, '_blank');
        }
      } else {
        const msg = (r.json?.error || r.text || 'Onbekende fout');
        setStatus('❌ Fout: ' + msg);
        alert('❌ Fout: ' + msg);
      }
    }catch(e){
      const msg = (e?.message || e);
      setStatus('❌ Fout: ' + msg);
      alert('❌ Fout: ' + msg);
    }
  }

  function fillExample(){
    $('players').value =
`# email,hcp,tee,gender,loop[,holes]
jan@example.com,18.4,WIT,H,WO
piet@example.com,9.2,GEEL,D,O
anne@example.com,+1.2,ROOD,D,NOORD,18
`;
    updatePreview();
  }

  (function init(){
    $('players').addEventListener('input', updatePreview);
    ['apiUrl','eventCode','adminKey','adminEmail'].forEach(id => $(id).addEventListener('input', ()=>{
      // build scoreboard hint only when both exist
      const apiUrl = norm($('apiUrl').value);
      const eventCode = norm($('eventCode').value);
      if (apiUrl && eventCode){
        $('pillScoreboard').textContent = 'scoreboard: link klaar';
      } else {
        $('pillScoreboard').textContent = 'scoreboard: —';
      }
    }));

    // sensible defaults from localStorage (optional)
    try{
      $('apiUrl').value = localStorage.getItem('stable_admin_api') || '';
      $('eventCode').value = localStorage.getItem('stable_admin_event') || '';
      $('adminEmail').value = localStorage.getItem('stable_admin_email') || '';
    }catch{}

    ['apiUrl','eventCode','adminEmail'].forEach(id=>{
      $(id).addEventListener('change', ()=>{
        try{
          if (id==='apiUrl') localStorage.setItem('stable_admin_api', norm($('apiUrl').value));
          if (id==='eventCode') localStorage.setItem('stable_admin_event', norm($('eventCode').value));
          if (id==='adminEmail') localStorage.setItem('stable_admin_email', norm($('adminEmail').value));
        }catch{}
      });
    });

    updatePreview();
  })();
</script>
</body>
</html>
