<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – Stableford</title>

  <style>
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:#070A12;
      color:#F3F6FF;
    }
    .wrap{ max-width:960px; margin:0 auto; padding:18px; }
    .card{
      background:#0E1422;
      border:1px solid #24304A;
      border-radius:16px;
      padding:16px;
    }
    h1{ margin:0; font-size:22px; }
    .sub{ margin-top:6px; color:#A7B1C8; font-size:13px; }

    label{
      display:block;
      margin:14px 0 6px;
      color:#A7B1C8;
      font-size:12px;
      font-weight:900;
      letter-spacing:.02em;
    }
    input, textarea{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid #24304A;
      background:#060A14;
      color:#F3F6FF;
      font-size:14px;
      outline:none;
    }
    textarea{
      min-height:240px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size:13px;
    }
    input:focus, textarea:focus{
      border-color:#1FA67A;
      box-shadow:0 0 0 2px rgba(31,166,122,.2);
    }

    .row{ display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; }
    button{
      padding:12px 16px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:#1FA67A;
      color:#fff;
      font-weight:1000;
      font-size:15px;
      cursor:pointer;
    }
    button:hover{ filter:brightness(1.1); }

    .status{
      margin-top:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      border-radius:14px;
      padding:10px 12px;
      color:#A7B1C8;
      font-size:13px;
      white-space:pre-wrap;
      min-height:48px;
    }

    .hint{
      margin-top:10px;
      color:#A7B1C8;
      font-size:12.5px;
      line-height:1.4;
    }
    .hint code{
      background:#060A14;
      border:1px solid #24304A;
      border-radius:8px;
      padding:2px 6px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      color:#F3F6FF;
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>Admin – Stableford</h1>
    <div class="sub">
      Maak één Stableford-ronde aan en verstuur de spelerslinks per e-mail.
    </div>

    <label for="apiUrl">Apps Script API (exec)</label>
    <input id="apiUrl" placeholder="https://script.google.com/macros/s/.../exec" />

    <label for="eventCode">Event code</label>
    <input id="eventCode" placeholder="bijv. Simke" />

    <label for="adminKey">Admin key</label>
    <input id="adminKey" placeholder="(uit CONFIG.admin_key)" />

    <label for="adminEmail">Admin e-mail (samenvatting)</label>
    <input id="adminEmail" type="email" placeholder="bijv. simketejong@gmail.com" />

    <label for="players">Spelers (1 per regel)</label>
    <textarea id="players"
      placeholder="email,hcp,tee,gender,loop[,holes]
bijv:
jan@club.nl,18.4,WIT,H,O
piet@club.nl,9.2,GEEL,D,WO
"></textarea>

    <div class="hint">
      Formaat per regel:<br/>
      <code>email,hcp,tee,gender,loop</code> of <code>email,hcp,tee,gender,loop,holes</code><br/>
      <br/>
      Loop: <code>O W Z N</code> (9 holes) of <code>WO OZ ZW ZO</code> (18 holes)
    </div>

    <div class="row">
      <button onclick="createRound()">Ronde aanmaken + mails versturen</button>
    </div>

    <div class="status" id="status">Status: klaar.</div>
  </div>
</div>

<script>
  const $ = id => document.getElementById(id);
  const status = msg => $('status').textContent = 'Status: ' + msg;

  function norm(s){ return String(s||'').trim(); }
  function isEmail(s){ return s.includes('@') && s.includes('.') && s.length >= 6; }

  function parsePlayers(){
    const lines = $('players').value.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    const out = [];
    for (let i=0;i<lines.length;i++){
      const p = lines[i].split(',').map(x=>x.trim());
      if (p.length < 5) throw `Regel ${i+1}: te weinig velden`;
      const [email,hcp,tee,gender,loop,holes] = p;
      if (!isEmail(email)) throw `Regel ${i+1}: ongeldig e-mail`;
      const h = Number(String(hcp).replace(',','.'));
      if (!Number.isFinite(h)) throw `Regel ${i+1}: ongeldig hcp`;
      const ho = holes ? Number(holes) : undefined;
      if (ho && ho !== 9 && ho !== 18) throw `Regel ${i+1}: holes moet 9 of 18 zijn`;
      out.push({
        email: email.toLowerCase(),
        hcp: h,
        tee: tee.toUpperCase(),
        gender: gender.toUpperCase(),
        loop_id: loop.toUpperCase(),
        holes: ho
      });
    }
    if (!out.length) throw 'Geen geldige spelers';
    return out;
  }

  async function createRound(){
    try{
      const apiUrl = norm($('apiUrl').value);
      const eventCode = norm($('eventCode').value);
      const adminKey = norm($('adminKey').value);
      const adminEmail = norm($('adminEmail').value);

      if (!apiUrl) throw 'API URL ontbreekt';
      if (!eventCode) throw 'Event code ontbreekt';
      if (!adminKey) throw 'Admin key ontbreekt';
      if (!isEmail(adminEmail)) throw 'Admin e-mail ongeldig';

      const players = parsePlayers();
      status('Bezig… ronde maken en e-mails versturen…');

      const body = new URLSearchParams();
      body.set('payload', JSON.stringify({
        action:'adminCreateRoundMixed',
        admin_key: adminKey,
        admin_email: adminEmail,
        event_code: eventCode,
        api_url: apiUrl,
        players
      }));

      const res = await fetch(apiUrl, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body
      });

      const text = await res.text();
      let json=null; try{ json=JSON.parse(text); }catch{}

      if (!json || !json.ok){
        throw json?.error || text || 'Onbekende fout';
      }

      status(
        `✅ Gelukt\n` +
        `Event: ${json.event_code}\n` +
        `Round: ${json.round_id}\n` +
        `Spelers: ${json.players_created}\n` +
        `Mails verzonden: ${json.mails_sent}\n\n` +
        `Scoreboard:\n${json.scoreboard_url}`
      );

      if (confirm('Ronde aangemaakt. Scoreboard openen?')){
        window.open(json.scoreboard_url,'_blank');
      }

    }catch(e){
      status('❌ Fout: ' + e);
    }
  }
</script>
</body>
</html>
