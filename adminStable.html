<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin – Stableford</title>
  <style>
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:#070A12; color:#F3F6FF; }
    .wrap{ max-width:980px; margin:0 auto; padding:18px; }
    .card{ background:#0E1422; border:1px solid #24304A; border-radius:16px; padding:16px; }
    h1{ margin:0; font-size:22px; }
    .sub{ margin-top:6px; color:#A7B1C8; font-size:13px; }

    label{ display:block; margin:14px 0 6px; color:#A7B1C8; font-size:12px; font-weight:900; }
    input, textarea{
      width:100%; padding:12px; border-radius:12px; border:1px solid #24304A;
      background:#060A14; color:#F3F6FF; font-size:14px; outline:none;
    }
    textarea{ min-height:240px; font-family:ui-monospace,Menlo,Consolas,monospace; font-size:13px; }
    input:focus, textarea:focus{ border-color:#1FA67A; box-shadow:0 0 0 2px rgba(31,166,122,.2); }

    button{
      margin-top:14px;
      padding:12px 16px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background:#1FA67A;
      color:#fff;
      font-weight:1000;
      font-size:15px;
      cursor:pointer;
    }
    button:hover{ filter:brightness(1.1); }

    .hint{ margin-top:10px; color:#A7B1C8; font-size:12.5px; line-height:1.4; }
    .hint code{ background:#060A14; border:1px solid #24304A; border-radius:8px; padding:2px 6px; color:#F3F6FF; }

    .status{
      margin-top:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      border-radius:14px;
      padding:10px 12px;
      color:#A7B1C8;
      font-size:13px;
      white-space:pre-wrap;
      min-height:52px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Admin – Stableford</h1>
    <div class="sub">Maak 1 event aan en verstuur links naar spelers. (E-mails worden niet opgeslagen.)</div>

    <label>Apps Script API (exec)</label>
    <input id="apiUrl" placeholder="https://script.google.com/macros/s/.../exec" />

    <label>Event code</label>
    <input id="eventCode" placeholder="bijv. Maarten01" />

    <label>Admin key</label>
    <input id="adminKey" placeholder="uit CONFIG.admin_key" />

    <label>Admin e-mail (samenvatting)</label>
    <input id="adminEmail" type="email" placeholder="bijv. simketejong@gmail.com" />

    <label>Spelers (1 per regel)</label>
    <textarea id="players" placeholder="email,hcp,teebox,gender,loopcode
bijv:
jan@club.nl,18.4,wit,heren,o
piet@club.nl,9.2,Geel,dames,wo
"></textarea>

    <div class="hint">
      Formaat: <code>email,hcp,teebox,gender,loopcode</code><br/>
      Teebox: wit/geel/blauw/rood/oranje (case maakt niet uit)<br/>
      Gender: heren/h/m/man of dames/d/v/vrouw (case maakt niet uit)<br/>
      Loop: o/w/z/n of wo/oz/zw/zo of uitgeschreven (case maakt niet uit)
    </div>

    <button onclick="createRound()">Ronde aanmaken + mails versturen</button>

    <div class="status" id="status">Status: klaar.</div>
  </div>
</div>

<script>
  const $ = id => document.getElementById(id);
  const status = msg => $('status').textContent = 'Status: ' + msg;

  function norm(s){ return String(s||'').trim(); }
  function isEmail(s){ const e=norm(s).toLowerCase(); return e.includes('@') && e.includes('.') && e.length>=6; }

  function parsePlayers(){
    const lines = $('players').value.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if (!lines.length) throw 'Geen spelers ingevoerd';

    const out = [];
    for (let i=0;i<lines.length;i++){
      const parts = lines[i].split(',').map(x=>x.trim());
      if (parts.length !== 5) throw `Regel ${i+1}: moet precies 5 velden zijn (email,hcp,teebox,gender,loopcode)`;

      const email = parts[0];
      const hcp = Number(String(parts[1]).replace(',','.'));
      const tee = parts[2];
      const gender = parts[3];
      const loop_id = parts[4];

      if (!isEmail(email)) throw `Regel ${i+1}: ongeldig e-mail`;
      if (!Number.isFinite(hcp)) throw `Regel ${i+1}: ongeldig hcp`;

      out.push({ email: email.toLowerCase(), hcp, tee, gender, loop_id });
    }
    return out;
  }

  async function createRound(){
    try{
      const apiUrl = norm($('apiUrl').value);
      const eventCode = norm($('eventCode').value);
      const adminKey = norm($('adminKey').value);
      const adminEmail = norm($('adminEmail').value);

      if (!apiUrl) throw 'API URL ontbreekt';
      if (!eventCode) throw 'Event code ontbreekt';
      if (!adminKey) throw 'Admin key ontbreekt';
      if (!isEmail(adminEmail)) throw 'Admin e-mail ongeldig';

      const players = parsePlayers();

      status('Bezig… ronde maken en e-mails versturen…');

      const body = new URLSearchParams();
      body.set('payload', JSON.stringify({
        action:'adminCreateRoundMixed',
        admin_key: adminKey,
        admin_email: adminEmail,
        event_code: eventCode,
        api_url: apiUrl,
        players
      }));

      const res = await fetch(apiUrl, {
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
        body
      });

      const text = await res.text();
      let json=null; try{ json=JSON.parse(text); }catch{}

      if (!json || !json.ok) throw (json?.error || text || 'Onbekende fout');

      status(
        `✅ Gelukt\n` +
        `Event: ${json.event_code}\n` +
        `Round: ${json.round_id}\n` +
        `Spelers: ${json.players_created}\n` +
        `Mails verzonden: ${json.mails_sent}\n\n` +
        `Scoreboard:\n${json.scoreboard_url}`
      );

      if (confirm('Ronde aangemaakt. Scoreboard openen?')){
        window.open(json.scoreboard_url, '_blank');
      }
    }catch(e){
      status('❌ Fout: ' + e);
    }
  }
</script>
</body>
</html>
