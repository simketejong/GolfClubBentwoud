<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Stableford – Speler</title>
  <style>
    :root{
      --bg:#070A12; --panel:#0E1422; --line:#24304A; --text:#F3F6FF; --muted:#A7B1C8;
      --green:#17b26a; --greenBg:rgba(23,178,106,.18);
      --red:#ff5c5c; --redBg:rgba(255,92,92,.18);
      --shadow:0 18px 48px rgba(0,0,0,.55);
      --r:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 700px at 50% -10%, #1b2a66 0%, rgba(27,42,102,0) 55%), var(--bg);
      color:var(--text);
    }
    .wrap{ max-width:520px; margin:0 auto; padding:14px; }
    .card{ background:var(--panel); border:1px solid var(--line); border-radius:var(--r); padding:14px; box-shadow:var(--shadow); }
    h1{ margin:0; font-size:22px; }
    .sub{ margin-top:6px; color:var(--muted); font-size:13px; line-height:1.35; }

    label{ display:block; margin:14px 0 6px; color:var(--muted); font-size:12px; font-weight:900; letter-spacing:.02em; }
    input{
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.28);
      color:var(--text);
      font-size:16px;
      outline:none;
    }
    input:focus{ border-color: rgba(23,178,106,.75); box-shadow:0 0 0 2px rgba(23,178,106,.18); }

    .row{ display:flex; gap:10px; }
    .row > div{ flex:1; }

    button{
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      font-weight:1100;
      font-size:16px;
      cursor:pointer;
      margin-top:14px;
    }
    .btnGreen{ background: var(--green); }
    .btnRed{ background: var(--red); }
    .btnRed[disabled]{ opacity:.75; cursor:not-allowed; }

    .pillRow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:12px; }
    .pill{
      border:1px solid rgba(255,255,255,.12);
      border-radius:999px;
      padding:7px 10px;
      background: rgba(0,0,0,.22);
      color:var(--muted);
      font-size:12px;
    }

    .big{
      margin-top:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px;
    }
    .big .k{ color:var(--muted); font-size:12px; font-weight:900; letter-spacing:.02em; }
    .big .v{ margin-top:6px; font-size:22px; font-weight:1200; }

    .status{
      margin-top:12px;
      white-space:pre-wrap;
      color:var(--muted);
      font-size:13px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      border-radius:16px;
      padding:10px 12px;
      min-height:44px;
    }
    .hide{ display:none !important; }
  </style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Stableford</h1>
    <div class="sub">Check-in → daarna per hole slagen invullen en verzenden.</div>

    <div class="pillRow">
      <span class="pill" id="pillApi">api: —</span>
      <span class="pill" id="pillPid">pid: —</span>
    </div>

    <!-- CHECKIN -->
    <div id="checkinBox">
      <label>Event code</label>
      <input id="eventCode" placeholder="bijv. Maarten01" />

      <label>Roeptnaam (optioneel, niet opgeslagen)</label>
      <input id="displayName" placeholder="bijv. Simke" />

      <button class="btnGreen" onclick="doCheckin()">Check-in</button>
    </div>

    <!-- SCORING -->
    <div id="scoreBox" class="hide">
      <div class="big">
        <div class="k">Huidige hole</div>
        <div class="v" id="curHole">—</div>
      </div>

      <div class="big">
        <div class="k">Punten tot nu</div>
        <div class="v" id="pointsSoFar">0</div>
      </div>

      <label>Slagen op deze hole</label>
      <input id="strokes" inputmode="numeric" placeholder="bijv. 5" />

      <button id="submitBtn" class="btnRed" onclick="submitScore()">Verzenden…</button>
    </div>

    <div class="status" id="status">Status: klaar.</div>
  </div>
</div>

<script>
  const qs = new URLSearchParams(location.search);
  const api = qs.get('api') || '';
  const pid = qs.get('pid') || '';
  const token = qs.get('t') || qs.get('token') || '';
  const evFromUrl = qs.get('event_code') || '';

  const $ = (id)=>document.getElementById(id);
  const setStatus = (s)=> $('status').textContent = 'Status: ' + s;

  $('pillApi').textContent = 'api: ' + (api ? 'OK' : 'ONTBREEKT');
  $('pillPid').textContent = 'pid: ' + (pid || 'ONTBREEKT');
  $('eventCode').value = evFromUrl;

  let totalHoles = 9;
  let currentHole = 1;
  let points = 0;

  async function apiPost(payload){
    const body = new URLSearchParams();
    body.set('payload', JSON.stringify(payload));
    const res = await fetch(api, {
      method:'POST',
      headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
      body
    });
    const text = await res.text();
    let json=null; try{ json = JSON.parse(text); }catch{}
    return {res,text,json};
  }

  async function apiGet(params){
    const u = new URL(api);
    Object.entries(params).forEach(([k,v])=>u.searchParams.set(k,String(v)));
    const res = await fetch(u.toString(), { method:'GET' });
    const text = await res.text();
    let json=null; try{ json = JSON.parse(text); }catch{}
    return {res,text,json};
  }

  function showScoreUi(){
    $('checkinBox').classList.add('hide');
    $('scoreBox').classList.remove('hide');
    updateUi();
  }

  function updateUi(){
    $('curHole').textContent = String(currentHole);
    $('pointsSoFar').textContent = String(points);
    $('strokes').value = '';
    $('strokes').focus();
    $('submitBtn').className = 'btnRed';
    $('submitBtn').textContent = 'Verzenden…';
    $('submitBtn').disabled = false;
  }

  async function syncFromRoundState(){
    const eventCode = $('eventCode').value.trim();
    const r = await apiGet({ action:'roundState', event_code: eventCode });
    if (!r.json || !r.json.ok) return;

    const players = Array.isArray(r.json.players) ? r.json.players : [];
    const me = players.find(p => String(p.player_id||'') === pid);
    if (me){
      totalHoles = Number(me.holes || 9) || 9;
    }

    const sb = Array.isArray(r.json.scoreboard) ? r.json.scoreboard : [];
    const my = sb.find(s => String(s.player_id||'') === pid);
    if (my){
      points = Number(my.total_points || 0);
      const thru = Number(my.thru || 0);
      currentHole = Math.min(totalHoles, thru + 1);
    }else{
      points = 0;
      currentHole = 1;
    }
  }

  async function doCheckin(){
    try{
      if (!api) throw 'API ontbreekt (open via de e-mail link)';
      if (!pid || !token) throw 'PID/token ontbreekt (open via de e-mail link)';

      const eventCode = $('eventCode').value.trim();
      if (!eventCode) throw 'Vul event code in';

      const displayName = $('displayName').value.trim();

      setStatus('Check-in…');
      const r = await apiPost({
        action:'checkin',
        event_code:eventCode,
        player_id:pid,
        token:token,
        display_name: displayName
      });

      if (!r.json || !r.json.ok) throw (r.json?.error || r.text || 'Check-in fout');

      await syncFromRoundState();
      showScoreUi();
      setStatus('✅ Check-in gelukt');
    }catch(e){
      setStatus('❌ ' + (e?.message || e));
    }
  }

  async function submitScore(){
    try{
      const eventCode = $('eventCode').value.trim();
      if (!eventCode) throw 'Event code ontbreekt';
      const s = Number(($('strokes').value||'').trim());
      if (!Number.isFinite(s) || s < 1 || s > 20) throw 'Ongeldig aantal slagen';

      $('submitBtn').disabled = true;
      $('submitBtn').textContent = 'Verzenden…';
      $('submitBtn').className = 'btnRed';

      const displayName = $('displayName').value.trim();

      const r = await apiPost({
        action:'submitScore',
        event_code:eventCode,
        player_id:pid,
        token:token,
        hole: currentHole,
        strokes: s,
        display_name: displayName
      });

      if (!r.json || !r.json.ok){
        $('submitBtn').disabled = false;
        throw (r.json?.error || r.text || 'Verzenden mislukt');
      }

      // refresh totals from server
      await syncFromRoundState();

      alert('Gelukt!');
      if (currentHole >= totalHoles){
        setStatus('✅ Klaar!');
        $('submitBtn').textContent = 'Klaar';
        $('submitBtn').className = 'btnGreen';
        return;
      }

      setStatus(`✅ Hole ${currentHole-1} opgeslagen`);
      updateUi();
    }catch(e){
      $('submitBtn').disabled = false;
      setStatus('❌ ' + (e?.message || e));
    }
  }

  // If event_code came via URL you still must press check-in (by design)
</script>
</body>
</html>
