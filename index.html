<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Matchplay</title>
  <style>
    :root{
      --bg:#0b0c10;
      --card:#11131a;
      --muted:#9aa3b2;
      --text:#eef1f7;
      --line:#262b36;
      --btn:#1a1f2b;
      --btn2:#20283a;
      --good:#19c37d;
      --warn:#ffcc00;
      --bad:#ff4d4d;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r:18px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 600px at 50% -10%, #1a2140 0%, var(--bg) 55%);
      color:var(--text);
    }
    .wrap{ max-width:520px; margin:0 auto; padding:18px 14px 28px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:16px;
    }
    h1{ font-size:20px; margin:0 0 10px; }
    .sub{ color:var(--muted); font-size:13px; line-height:1.35; }
    .pillrow{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .pill{
      border:1px solid var(--line);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      color:var(--muted);
      background: rgba(255,255,255,.02);
    }
    label{ display:block; margin:14px 0 6px; font-weight:700; font-size:13px; }
    input{
      width:100%;
      padding:14px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color:var(--text);
      font-size:16px;
      outline:none;
    }
    input:focus{ border-color:#3b82f6; }
    .row{ display:flex; gap:10px; }
    .row>*{ flex:1; }
    button{
      width:100%;
      padding:16px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      color:var(--text);
      font-size:16px;
      font-weight:800;
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{ transform: translateY(1px); }
    .btnSecondary{ background: rgba(255,255,255,.03); font-weight:700; }
    .btnGood{ border-color: rgba(25,195,125,.5); }
    .btnBad{ border-color: rgba(255,77,77,.7); }
    .btnWarn{ border-color: rgba(255,204,0,.7); }

    .scoreHead{
      display:flex;
      gap:10px;
      margin-top:12px;
    }
    .scoreBox{
      flex:1;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: rgba(255,255,255,.02);
    }
    .scoreBox .k{ color:var(--muted); font-size:12px; }
    .scoreBox .v{ font-size:20px; font-weight:900; margin-top:3px; }
    .holeLine{
      margin-top:14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: rgba(255,255,255,.02);
    }
    .holeLine .k{ color:var(--muted); font-size:12px; }
    .holeLine .v{ font-size:22px; font-weight:900; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:12px; }
    .tiny{ font-size:12px; color:var(--muted); margin-top:10px; line-height:1.35; }
    .status{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,.25);
      white-space:pre-wrap;
      font-size:13px;
      color:var(--muted);
    }

    video{ width:100%; border-radius:16px; border:1px solid var(--line); margin-top:10px; }

    .hidden{ display:none !important; }

    /* Popup */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.65);
      display:flex; align-items:center; justify-content:center;
      padding:18px;
      z-index:1000;
    }
    .modal{
      width:min(520px, 100%);
      border-radius:22px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      padding:18px;
      text-align:center;
    }
    .modal .big{ font-size:22px; font-weight:1000; margin:6px 0; }
    .modal .small{ color:var(--muted); font-size:13px; line-height:1.4; }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- HEADER CARD -->
    <div class="card">
      <h1>Matchplay</h1>
      <div class="sub" id="subtitle">Open via mail-link. Scan QR bij de wedstrijdtafel en check in.</div>

      <div class="pillrow">
        <div class="pill" id="pillMatch">match: —</div>
        <div class="pill" id="pillPid">pid: —</div>
        <div class="pill" id="pillCheck">check-in: ✖</div>
      </div>

      <!-- Hidden technical fields from mail-link -->
      <input id="matchId" class="hidden" />
      <input id="playerId" class="hidden" />
      <input id="token" class="hidden" />

      <!-- STEP 1: EVENT + CHECKIN -->
      <div id="screenCheckin" style="margin-top:14px;">
        <label>Event code</label>
        <input id="eventCode" placeholder="MP2026" inputmode="latin-prose" />

        <div class="row" style="margin-top:10px;">
          <button class="btnSecondary" onclick="startQrScan()">Scan QR</button>
          <button class="btnSecondary" onclick="stopQrScan()">Stop</button>
        </div>

        <video id="video" class="hidden" playsinline></video>

        <div class="tiny">
          Als QR scanning niet werkt: vul event code handmatig in.<br/>
          Tip: Chrome + HTTPS werkt het best.
        </div>

        <div style="margin-top:12px;">
          <button class="btnGood" onclick="doCheckin()">Check-in</button>
        </div>
      </div>

      <!-- STEP 2: SCORING -->
      <div id="screenScoring" class="hidden" style="margin-top:14px;">
        <div class="scoreHead">
          <div class="scoreBox">
            <div class="k">Huidige stand</div>
            <div class="v" id="scoreLabel">—</div>
          </div>
          <div class="scoreBox">
            <div class="k">Thru</div>
            <div class="v" id="scoreThru">—</div>
          </div>
        </div>

        <div class="holeLine">
          <div>
            <div class="k">Hole</div>
            <div class="v" id="holeView">1</div>
          </div>
          <div style="text-align:right;">
            <div class="k">Jouw keuze</div>
            <div class="v" id="yourPick">—</div>
          </div>
        </div>

        <div class="grid3">
          <button id="btnUP"   onclick="pick('UP')">UP</button>
          <button id="btnDOWN" onclick="pick('DOWN')">DOWN</button>
          <button id="btnAS"   onclick="pick('AS')">AS</button>
        </div>

        <div class="tiny">
          Na jouw keuze: we wachten automatisch op de andere speler (check elke 5s).<br/>
          Bij mismatch wordt alles rood en moeten jullie opnieuw kiezen.
        </div>
      </div>

      <div class="status" id="status">Status: klaar</div>
    </div>
  </div>

  <!-- POPUP -->
  <div id="overlay" class="overlay hidden" onclick="closePopup()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="big" id="popTitle">✅ Gelukt</div>
      <div class="small" id="popText">Naar volgende hole…</div>
      <div style="margin-top:14px;">
        <button class="btnGood" onclick="closePopup()">OK</button>
      </div>
    </div>
  </div>

<script>
  // Filled from mail-link: ?api=.../exec&match=...&pid=...&t=...
  let API_URL = "";
  let checkedIn = false;

  // current hole
  let hole = 1;

  // local UI state
  let myPick = null;
  let pollTimer = null;
  let lastHoleState = null; // from matchState holes[hole-1]

  function $(id){ return document.getElementById(id); }

  function setStatus(msg){ $('status').textContent = 'Status: ' + msg; }
  function setPills(){
    $('pillMatch').textContent = 'match: ' + ($('matchId').value || '—');
    $('pillPid').textContent   = 'pid: ' + ($('playerId').value || '—');
    $('pillCheck').textContent = 'check-in: ' + (checkedIn ? '✔' : '✖');
  }

  function showCheckin(){
    $('screenCheckin').classList.remove('hidden');
    $('screenScoring').classList.add('hidden');
    $('subtitle').textContent = 'Scan QR bij de wedstrijdtafel en check in.';
  }
  function showScoring(){
    $('screenCheckin').classList.add('hidden');
    $('screenScoring').classList.remove('hidden');
    $('subtitle').textContent = 'Live score. Vul per hole UP / DOWN / AS in.';
  }

  function setButtonsMode(mode){
    // mode: normal | waiting | mismatch | disabled
    const btns = [$('btnUP'), $('btnDOWN'), $('btnAS')];
    btns.forEach(b=>{
      b.classList.remove('btnBad','btnWarn');
      b.disabled = false;
      b.style.opacity = '1';
    });

    if (mode === 'disabled'){
      btns.forEach(b=>{ b.disabled = true; b.style.opacity='.55'; });
      return;
    }

    if (mode === 'waiting'){
      // chosen button goes red
      if (myPick === 'UP') $('btnUP').classList.add('btnBad');
      if (myPick === 'DOWN') $('btnDOWN').classList.add('btnBad');
      if (myPick === 'AS') $('btnAS').classList.add('btnBad');
      return;
    }

    if (mode === 'mismatch'){
      btns.forEach(b=> b.classList.add('btnBad'));
      return;
    }
  }

  function updateHoleUI(){
    $('holeView').textContent = String(hole);
    $('yourPick').textContent = myPick || '—';
  }

  function getDeviceId(){
    let id = localStorage.getItem('device_id');
    if (!id){
      id = 'dev-' + Math.random().toString(16).slice(2) + '-' + Date.now();
      localStorage.setItem('device_id', id);
    }
    return id;
  }

  // ---------- URL params ----------
  function applyUrlParams(){
    const p = new URLSearchParams(location.search);
    const api = p.get('api');
    if (api) API_URL = api;

    const match = p.get('match');
    const pid = p.get('pid');
    const t = p.get('t');

    if (match) $('matchId').value = match;
    if (pid) $('playerId').value = pid;
    if (t) $('token').value = t;

    setPills();
  }

  // ---------- GPS ----------
  function getGpsOnce({timeoutMs=5000, highAccuracy=false} = {}){
    return new Promise(resolve=>{
      if (!navigator.geolocation) return resolve({ gps_status:'no_geolocation' });

      let done=false;
      const timer=setTimeout(()=>{
        if(done) return;
        done=true;
        resolve({ gps_status:'timeout' });
      }, timeoutMs);

      navigator.geolocation.getCurrentPosition(
        pos=>{
          if(done) return;
          done=true; clearTimeout(timer);
          resolve({
            gps_status:'ok',
            lat: pos.coords.latitude,
            lng: pos.coords.longitude,
            accuracy_m: pos.coords.accuracy
          });
        },
        err=>{
          if(done) return;
          done=true; clearTimeout(timer);
          let s='error';
          if (err && err.code===1) s='denied';
          if (err && err.code===2) s='no_fix';
          resolve({ gps_status:s });
        },
        { enableHighAccuracy: highAccuracy, maximumAge:0 }
      );
    });
  }

  // ---------- API helpers (form-urlencoded, avoids CORS preflight) ----------
  async function apiPost(payloadObj){
    if (!API_URL) throw new Error('API URL ontbreekt in mail-link (api=...)');

    const data = new URLSearchParams();
    data.set('payload', JSON.stringify(payloadObj));

    const res = await fetch(API_URL, {
      method:"POST",
      headers:{ "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
      body: data.toString()
    });

    const text = await res.text();
    let json=null;
    try{ json=JSON.parse(text); } catch {}
    return { ok:res.ok, status:res.status, text, json };
  }

  async function apiGet(url){
    const res = await fetch(url, { method:"GET" });
    const text = await res.text();
    let json=null;
    try{ json=JSON.parse(text); } catch {}
    return { ok:res.ok, status:res.status, text, json };
  }

  // ---------- CHECKIN ----------
  async function doCheckin(){
    try{
      const matchId = $('matchId').value.trim();
      const pid = $('playerId').value.trim();
      const eventCode = $('eventCode').value.trim();
      const token = $('token').value.trim();

      if (!matchId || !pid) return setStatus('Open via mail-link (?match=...&pid=...&t=...).');
      if (!eventCode) return setStatus('Vul event code in of scan QR.');

      setButtonsMode('disabled');
      setStatus('Check-in: GPS ophalen…');
      const gps = await getGpsOnce({ timeoutMs: 5000, highAccuracy: true });

      setStatus('Check-in sturen…');
      const payload = {
        action: "checkin",
        event_code: eventCode,
        match_id: matchId,
        player_id: pid,
        token,
        device_id: getDeviceId(),
        ...gps
      };

      const r = await apiPost(payload);
      if (r.json && r.json.ok){
        checkedIn = true;
        setPills();
        showScoring();
        setButtonsMode('normal');
        updateHoleUI();
        setStatus('Check-in OK. Klaar voor hole 1.');
        await refreshStateAndPaint();
      } else {
        setButtonsMode('normal');
        setStatus(`Check-in fout (HTTP ${r.status})\n${r.text}`);
      }
    }catch(e){
      setButtonsMode('normal');
      setStatus('Fout: ' + (e?.message || e));
    }
  }

  // ---------- SCORING FLOW ----------
  async function pick(result){
    try{
      if (!checkedIn) return setStatus('Eerst check-in.');
      if (!result) return;

      myPick = result;
      updateHoleUI();
      setButtonsMode('disabled');
      setStatus('Score sturen…');

      const matchId = $('matchId').value.trim();
      const pid = $('playerId').value.trim();

      // optional GPS best-effort (short)
      const gps = await getGpsOnce({ timeoutMs: 2500, highAccuracy: false });

      const payload = {
        action: "submitEvent",
        match_id: matchId,
        event_type: "hole_submit",
        source: "score_submit",
        hole_nr: hole,
        result: result,
        player_id: pid,
        confirmed: false,
        device_id: getDeviceId(),
        ...gps
      };

      const r = await apiPost(payload);
      if (!(r.json && r.json.ok)){
        setButtonsMode('normal');
        return setStatus(`Submit fout (HTTP ${r.status})\n${r.text}`);
      }

      // now we wait/poll until state becomes confirmed or mismatch
      setButtonsMode('waiting');
      setStatus('Wacht op score van andere speler…');
      startPolling();
    }catch(e){
      setButtonsMode('normal');
      setStatus('Fout: ' + (e?.message || e));
    }
  }

  function startPolling(){
    stopPolling();
    pollTimer = setInterval(async ()=>{
      await refreshStateAndPaint(true);
    }, 5000);
    // do an immediate poll too
    refreshStateAndPaint(true);
  }

  function stopPolling(){
    if (pollTimer){
      clearInterval(pollTimer);
      pollTimer = null;
    }
  }

  async function refreshNow(){
    await refreshStateAndPaint(false);
  }

  async function refreshStateAndPaint(fromPolling){
    const matchId = $('matchId').value.trim();
    if (!API_URL || !matchId) return;

    const r = await apiGet(`${API_URL}?action=matchState&match_id=${encodeURIComponent(matchId)}`);
    if (!(r.json && r.json.ok)){
      if (!fromPolling) setStatus(`matchState fout\n${r.text}`);
      return;
    }

    const st = r.json;
const net = Number(st.score?.net ?? 0);
const pid = $('playerId').value.trim();
const isA = pid === st.match?.player_a;

// POV-net: speler B ziet teken omgedraaid
const povNet = isA ? net : -net;
const povLabel = (povNet === 0) ? 'All Square' : (povNet > 0 ? `${povNet} Up` : `${Math.abs(povNet)} Down`);

$('scoreLabel').textContent = povLabel;
    $('scoreThru').textContent  = String(st.score?.thru ?? '—');

    // get current hole state
    const hObj = (st.holes || []).find(x => Number(x.hole) === Number(hole)) || null;
    lastHoleState = hObj;

    if (!hObj){
      if (!fromPolling) setStatus('Geen hole info.');
      return;
    }

    if (hObj.state === 'empty'){
      setButtonsMode('normal');
      if (!fromPolling) setStatus('Nog geen scores voor deze hole.');
      return;
    }

    if (hObj.state === 'waiting_other'){
      setButtonsMode('waiting');
      // keep waiting
      return;
    }

    if (hObj.state === 'mismatch'){
      // both entered but disagree (or interpret disagree)
      stopPolling();
      setButtonsMode('mismatch');
      myPick = null; // force re-pick
      updateHoleUI();
      setStatus('❌ Scores komen niet overeen.\nBeide spelers moeten opnieuw kiezen voor deze hole.');
      showPopup('❌ Scores kloppen niet', 'Kies opnieuw (beide spelers) voor dezelfde hole.');
      return;
    }

    if (hObj.state === 'confirmed'){
      stopPolling();
      setButtonsMode('normal');
      // advance hole
      const next = hole + 1;
      const done = next > 18;

      showPopup('✅ Gelukt', done ? 'Match klaar (18 holes gespeeld).' : `Naar hole ${next}…`);
      setStatus(done ? 'Match klaar.' : `Ga door naar hole ${next}.`);

      myPick = null;
      hole = Math.min(next, 18);
      updateHoleUI();

      return;
    }
  }

  // Admin/backdoor
  function forceNextHole(){
    hole = Math.min(hole + 1, 18);
    myPick = null;
    updateHoleUI();
    setButtonsMode('normal');
    setStatus('Volgende hole (admin) gezet. Let op: alleen voor testen.');
  }

  // ---------- POPUP ----------
  function showPopup(title, text){
    $('popTitle').textContent = title;
    $('popText').textContent = text;
    $('overlay').classList.remove('hidden');
    if (navigator.vibrate) navigator.vibrate([60,30,60]);
  }
  function closePopup(){
    $('overlay').classList.add('hidden');
  }

  // ---------- QR scanning ----------
  let stream=null;
  let scanTimer=null;

  function parseEventCodeFromQr(text){
    const t = String(text || '').trim();
    try{
      const u = new URL(t);
      const p = new URLSearchParams(u.search);
      return p.get('event_code') || p.get('event') || t;
    }catch{
      const m = t.match(/(?:event_code|event)\s*=\s*([A-Za-z0-9_-]+)/i);
      if (m) return m[1];
      return t;
    }
  }

  async function startQrScan(){
    if (!navigator.mediaDevices?.getUserMedia){
      setStatus('Camera niet beschikbaar op dit device.');
      return;
    }
    if (!('BarcodeDetector' in window)){
      setStatus('QR scanner niet beschikbaar. Gebruik Chrome of vul event code handmatig in.');
      return;
    }

    try{
      stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment' }, audio:false });
      $('video').srcObject = stream;
      $('video').classList.remove('hidden');
      await $('video').play();

      const detector = new BarcodeDetector({ formats:['qr_code'] });

      scanTimer = setInterval(async ()=>{
        try{
          const codes = await detector.detect($('video'));
          if (codes && codes.length){
            const raw = codes[0].rawValue || '';
            const eventCode = parseEventCodeFromQr(raw);
            $('eventCode').value = eventCode;
            setStatus(`QR OK: ${eventCode}`);
            stopQrScan();
          }
        }catch{}
      }, 350);

      setStatus('QR scan gestart…');
    }catch(e){
      setStatus('Camera fout: ' + (e?.message || e));
    }
  }

  function stopQrScan(){
    if (scanTimer){ clearInterval(scanTimer); scanTimer=null; }
    if (stream){
      stream.getTracks().forEach(t=>t.stop());
      stream=null;
    }
    $('video').pause();
    $('video').srcObject=null;
    $('video').classList.add('hidden');
  }

  // ---------- init ----------
  applyUrlParams();
  setPills();
  showCheckin();
  updateHoleUI();
  setStatus('Open via mail-link. Scan QR en check in.');
</script>
</body>
</html>
