<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Matchplay Admin – R1 setup</title>
  <style>
    body { font-family: system-ui, Arial; margin: 16px; }
    .card { max-width: 900px; margin: 0 auto; border: 1px solid #ddd; border-radius: 16px; padding: 16px; }
    label { display:block; margin-top: 12px; font-weight: 700; }
    input { width:100%; padding: 12px; font-size: 16px; margin-top: 6px; box-sizing: border-box; }
    button { padding: 12px 14px; font-size: 16px; border-radius: 12px; border: 1px solid #ccc; background:#fff; cursor: pointer; }
    button.primary { border-color:#000; }
    button.danger { border-color:#c00; }
    .row { display:flex; gap: 10px; }
    .row > * { flex: 1; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align:left; vertical-align: top; }
    .status { margin-top: 12px; padding: 10px; border-radius: 12px; background: #f6f6f6; white-space: pre-wrap; }
    .small { opacity:.75; font-size: 12px; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 12px; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <div class="card">
    <h2>Matchplay Admin – R1 setup</h2>
    <div class="small">
      Vul matches in (email A vs email B). Klik <b>Send R1 mails</b>.<br/>
      Dit gebruikt <span class="mono">x-www-form-urlencoded</span> zodat CORS-preflight wordt vermeden (Apps Script dingetje™).
    </div>

    <label>Apps Script API URL (exec)</label>
    <input id="apiUrl" placeholder="https://script.google.com/macros/s/.../exec" />

    <div class="row">
      <div>
        <label>Event code (kort)</label>
        <input id="eventCode" value="MP2026" />
      </div>
      <div>
        <label>Admin key</label>
        <input id="adminKey" placeholder="(uit Google Sheet config)" />
      </div>
    </div>

    <div style="margin-top:12px" class="row">
      <button onclick="addRow()">+ Add match</button>
      <button class="danger" onclick="clearAll()">Clear</button>
      <button class="primary" onclick="sendR1()">Send R1 mails</button>
    </div>

    <table id="tbl">
      <thead>
        <tr>
          <th style="width:50px;">#</th>
          <th>Email speler A</th>
          <th>Email speler B</th>
          <th style="width:120px;" class="right">Actie</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <div class="small" style="margin-top:10px;">
      Tip: je kunt ook meerdere regels in één keer plakken (tab/komma gescheiden) in de eerste cel.
    </div>

    <div id="status" class="status">Status: klaar.</div>
  </div>

<script>
  const tbody = document.querySelector('#tbl tbody');

  function setStatus(msg) {
    document.getElementById('status').textContent = 'Status: ' + msg;
  }

  function renumber() {
    [...tbody.children].forEach((tr,i) => tr.querySelector('[data-idx]').textContent = String(i+1));
  }

  function addRow(a='', b='') {
    const tr = document.createElement('tr');

    tr.innerHTML = `
      <td data-idx>0</td>
      <td><input type="email" placeholder="a@club.nl" value="${escapeHtml(a)}" /></td>
      <td><input type="email" placeholder="b@club.nl" value="${escapeHtml(b)}" /></td>
      <td class="right">
        <button onclick="removeRow(this)">Remove</button>
      </td>
    `;

    // paste helper: if user pastes multiple lines into first email cell
    const inputA = tr.children[1].querySelector('input');
    inputA.addEventListener('paste', (ev) => {
      const text = (ev.clipboardData || window.clipboardData).getData('text');
      if (!text) return;
      const lines = text.trim().split(/\r?\n/);
      // only handle multiline paste
      if (lines.length < 2) return;
      ev.preventDefault();

      // Expect each line: emailA [tab/comma/semicolon] emailB
      const parsed = [];
      for (const line of lines) {
        const parts = line.split(/[\t,;]+/).map(s => s.trim()).filter(Boolean);
        if (parts.length >= 2) parsed.push({a: parts[0], b: parts[1]});
      }
      if (!parsed.length) return;

      // fill current row with first, add the rest
      inputA.value = parsed[0].a;
      tr.children[2].querySelector('input').value = parsed[0].b;

      for (let i=1; i<parsed.length; i++) addRow(parsed[i].a, parsed[i].b);
      renumber();
      setStatus(`Geplakt: ${parsed.length} matches.`);
    });

    tbody.appendChild(tr);
    renumber();
  }

  function removeRow(btn) {
    btn.closest('tr').remove();
    renumber();
  }

  function clearAll() {
    tbody.innerHTML = '';
    addRow(); addRow(); addRow(); addRow();
    setStatus('Leeg gemaakt.');
  }

  function escapeHtml(s) {
    return String(s || '')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function collectPairs() {
    const pairs = [];
    [...tbody.children].forEach(tr => {
      const emailA = tr.children[1].querySelector('input').value.trim();
      const emailB = tr.children[2].querySelector('input').value.trim();
      if (emailA && emailB) pairs.push({ email_a: emailA, email_b: emailB });
    });
    return pairs;
  }

  async function sendR1() {
    const apiUrl = document.getElementById('apiUrl').value.trim();
    const eventCode = document.getElementById('eventCode').value.trim();
    const adminKey = document.getElementById('adminKey').value.trim();

    if (!apiUrl) return setStatus('API URL ontbreekt.');
    if (!eventCode) return setStatus('Event code ontbreekt.');
    if (!adminKey) return setStatus('Admin key ontbreekt.');

    const pairs = collectPairs();
    if (pairs.length < 1) return setStatus('Geen matches ingevuld.');

    setStatus(`Versturen… matches=${pairs.length}`);

    // IMPORTANT: use x-www-form-urlencoded to avoid CORS preflight for Apps Script
    const payload = {
      action: 'adminSetupR1',
      admin_key: adminKey,
      event_code: eventCode,
      pairs
    };

    const data = new URLSearchParams();
    data.set('payload', JSON.stringify(payload));

    try {
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: data.toString()
      });
      const text = await res.text();
      setStatus(`Response (HTTP ${res.status}):\n${text}`);
    } catch (e) {
      setStatus('Fout: ' + (e?.message || e));
    }
  }

  // init rows
  addRow(); addRow(); addRow(); addRow();
</script>
</body>
</html>
